openapi: 3.0.3
info:
  title: RAS/RM Survey Service
  description: A service for dealing with surveys, including collection exercises and collection instruments.
  version: "1.0"
servers:
  - url: https://localhost:8080
    description: The default path for Survey in either standard K8s port forwarding or when using ras-rm-cli
tags:
  - name: info
    description: Informational endpoints.
  - name: surveys
    description: Endpoints to interact with top-level surveys
  - name: collection-exercises
    description: Endpoints to interact with the collection exercises of a survey
  - name: collection-instruments
    description: Endpoints to interact with the collection instruments for a survey or collection exercise
paths:
  /info:
    get:
      summary: Returns basic information about the service.
      description: Returns basic information about the service.
      security: []
      tags:
        - info
      responses:
        '200':
          description: A JSON of basic information about the service.
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: survey
                  version:
                    type: string
                    example: "1.0.0"
        '404':
          description: The service is down or incorrectly configured.
  /health:
    get:
      summary: Returns health information about the service.
      description: Returns information on whether aspects of the service (database, queues etc) are up and the latency to them.
      security: []
      tags:
        - info
      responses:
        '200':
            description: A JSON of information on the health of the service.
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    database:
                      type: string
                      example: "UP 100ms"
                    rabbitmq:
                       type: string
                       example: "DOWN"
        '404':
          description: The service is down or incorrectly configured.
  /survey:
    get:
      summary: Returns survey information filtered by query parameters.
      description: Allows a search of surveys based on the query parameters provided.
      tags:
        - surveys
      parameters:
        - name: reference
          in: query
          description: The survey reference
          required: false
          schema:
            type: string
            example: '141'
        - name: shortName
          in: query
          description: The survey short name
          required: false
          schema:
            type: string
            example: 'ASHE'
        - name: longName
          in: query
          description: The survey long name
          required: false
          schema:
            type: string
            example: 'Annual Survey of Hours and Earnings'
      responses:
        '200':
          description: Information on the requested survey(s).
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/survey'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
    post:
      summary: Adds a new survey.
      description: Creates a new survey based on the provided requestBody.
      tags:
        - surveys
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/survey'
      responses:
        '201':
          description: The survey was successfully created and its attributes were returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/survey'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceOrFieldMissingError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
  /survey/{reference}:
    get:
      summary: Returns survey information for a particular survey.
      description: Retrieves a survey based on its survey reference.
      tags:
        - surveys
      parameters:
        - name: reference
          in: path
          description: The survey reference
          required: true
          schema:
            type: string
            example: '141'
      responses:
        '200':
          description: Information on the requested survey(s).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/survey'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
    delete:
      summary: Deletes a survey.
      description: Deletes a survey and its associated collection exercises and collection instruments.
      tags:
        - surveys
      parameters:
        - name: reference
          in: path
          description: The survey reference
          required: true
          schema:
            type: string
            example: '141'
      responses:
        '204':
          description: The survey and its associated entities have been deleted.
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
    patch:
      summary: Updates survey information.
      description: Updates the details of a survey such as its name or legal basis.
      tags:
        - surveys
      parameters:
        - name: reference
          in: path
          description: The survey reference
          required: true
          schema:
            type: string
            example: '141'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/survey'
      responses:
        '200':
          description: The survey was successfully updated and its new attributes were returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/survey'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceOrInvalidSchemaError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
  /survey/{reference}/collectioninstrument:
    post:
      summary: Adds a new collection instrument to a survey.
      description: Adds a new collection instrument to the specified survey for use in all related collection exercises.
      tags:
        - collection-instruments
      parameters:
        - name: reference
          in: path
          description: The survey reference
          required: true
          schema:
            type: string
            example: '141'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                collectionInstrument:
                  $ref: '#/components/schemas/collectionInstrument'
                SEFTFile:
                  type: string
                  format: binary
      responses:
        '201':
          description: The collection instrument was successfully uploaded and associated with the survey.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/collectionInstrument'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceOrInvalidSchemaError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SurveyNotFoundError'
  /collectionexercise:
    get:
      summary: Returns collection exercise information filtered by query parameters.
      description: Allows a search of collection exercises based on the query parameters provided.
      tags:
        - collection-exercises
      parameters:
        - name: reference
          in: query
          description: The survey reference
          required: false
          schema:
            type: string
            example: '141'
        - name: state
          in: query
          description: The state of the collection exercise
          required: false
          schema:
            $ref: '#/components/schemas/collectionExerciseState'
      responses:
        '200':
          description: Information on the requested collection exercise(s).
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/collectionExerciseShort'
        '400':
          $ref: '#/components/responses/InvalidSurveyReferenceOrInvalidStateError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/CollectionExerciseNotFoundError'
components:
  responses:
    InvalidSurveyReferenceError:
      description: The survey reference was in an invalid format (a 3-digit integer with leading zeroes if necessary, e.g. 052).
    InvalidSurveyReferenceOrInvalidSchemaError:
      description: The survey reference was in an invalid format (a 3-digit integer with leading zeroes if necessary, e.g. 052) or the requestBody was malformed.
    InvalidSurveyReferenceOrFieldMissingError:
      description: The survey reference was in an invalid format (a 3-digit integer with leading zeroes if necessary, e.g. 052) or a field was missing in the requestBody (all are mandatory).
    InvalidSurveyReferenceOrInvalidStateError:
      description: The survey reference was in an invalid format (a 3-digit integer with leading zeroes if necessary, e.g. 052) or the collection exercise state was invalid.
    UnauthorizedError:
      description: Authentication information is missing or invalid.
      headers:
        WWW_Authenticate:
          schema:
            type: string
    SurveyNotFoundError:
      description: A survey wasn't found for the provided ID or query parameters.
    CollectionExerciseNotFoundError:
      description: A collection exercise wasn't found for the provided ID or query parameters.
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
  schemas:
    survey:
      type: object
      properties:
        reference:
          type: string
          example: '141'
        shortName:
          type: string
          example: 'ASHE'
        longName:
          type: string
          example: 'Annual Survey of Hours and Earnings'
        legalBasis:
          type: string
          example: 'Statistics of Trade Act 1947'
        collectionInstruments:
          type: array
          items:
            $ref: '#/components/schemas/collectionInstrument'
    collectionExerciseShort:
      type: object
      properties:
        exerciseUUID:
          type: string
          format: uuid
          example: '6f1bf642-2f9c-408f-8ffe-93b40667d99a'
        surveyReference:
          type: string
          example: '141'
        state:
          $ref: '#/components/schemas/collectionExerciseState'
        mps:
          type: string
          format: date-time
        goLive:
          type: string
          format: date-time
        periodStart:
          type: string
          format: date-time
        periodEnd:
          type: string
          format: date-time
        employment:
          type: string
          format: date-time
        return:
          type: string
          format: date-time
        emails:
          type: array
          items:
            $ref: '#/components/schemas/collectionExerciseEmail'
    collectionExerciseEmail:
      type: object
      properties:
        emailType:
          type: string
          example: 'Reminder 1'
        scheduled:
          type: string
          format: date-time
    collectionExerciseState:
      type: string
      enum: ['INIT', 'CREATED', 'SCHEDULED', 'READY_FOR_REVIEW', 'EXECUTION_STARTED', 'EXECUTED', 'VALIDATED', 'FAILEDVALIDATION', 'READY_FOR_LIVE', 'LIVE']
    collectionInstrument:
      type: object
      properties:
        instrumentUUID:
          type: string
          format: uuid
          example: 'ddc37cb6-c88a-473b-949a-fa5fad9265a1'
        instrumentType:
          $ref: '#/components/schemas/collectionInstrumentType'
        classifiers:
          type: object
          properties:
            formType:
              type: string
              example: '0001'
            eqID:
              type: string
              example: '2'
        seftFilename:
          type: string
          example: 'seft_instrument.xls'
    collectionInstrumentType:
      type: string
      enum: ['EQ', 'SEFT']

security:  
  - basicAuth: []